<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="https://gmpg.org/xfn/11" rel="profile" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

  <title>
    
      Using Castle TypeFactory facility &middot; Thoughts
    
  </title>

  

  <!-- CSS -->
  <link rel="stylesheet" href="/assets/css/main.css" />
  <!-- <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface" /> -->
<!-- <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Merriweather:900,900italic,300,300italic"> -->
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:900,300">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/tonsky/FiraCode@1.207/distr/fira_code.css">


  <link href="//maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css" rel="stylesheet">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/favicon.png" />
<link rel="shortcut icon" href="/favicon.ico" />

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml" />

  <!-- Additional head bits without overriding original head -->
</head>

  <body class="post">

    <div id="sidebar">
  <header>
    <div class="site-title">
      <a href="/">
        
          <span class="back-arrow icon"><svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
  <path d="M0 0h24v24H0z" fill="none"/>
  <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
</svg></span>
        
        Thoughts
      </a>
    </div>
    <p class="lead">My thoughts on programming, motorcycles and life in general</p>
  </header>
  <nav id="sidebar-nav-links">
  
    <a class="home-link "
        href="/">Home</a>
  
  

  

  <a class="page-link "
          href="/about/">About</a>
    
  

  
    
      <a class="page-link "
          href="/archive/">Archive</a>
    
  

  

  

  
    
      <a class="page-link "
          href="/tags/">Tags</a>
  

  <!-- Optional additional links to insert in sidebar nav -->
</nav>

  

  <nav id="sidebar-icon-links">
  

  
  <a id="github-link"
     class="fa fa-github icon" title="Github" aria-label="Github"
     href="https://github.com/vignessh">
  </a>
  

  
  <a id="twitter-link"
     class="fa fa-twitter icon" title="Twitter" aria-label="Twitter"
     href="https://twitter.com/vignesshv">
  </a>
  

  
  <a id="instagram-link"
     class="fa fa-instagram icon" title="Instagram" aria-label="Instagram"
     href="https://instagram.com/vignesshv">
  </a>
  

  
  <a id="instagram-link"
     class="fa fa-linkedin icon" title="LinkedIn" aria-label="LinkedIn"
     href="https://www.linkedin.com/vignesshv">
  </a>
  

  
  <a id="instagram-link"
     class="fa fa-flickr icon" title="Flickr" aria-label="Flickr"
     href="https://www.flickr.com/vignessh">
  </a>
  

  <a id="subscribe-link"
     class="icon" title="Subscribe" aria-label="Subscribe"
     href="/feed.xml">
    <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <circle cx="6.18" cy="17.82" r="2.18"/>
    <path d="M4 4.44v2.83c7.03 0 12.73 5.7 12.73 12.73h2.83c0-8.59-6.97-15.56-15.56-15.56zm0 5.66v2.83c3.9 0 7.07 3.17 7.07 7.07h2.83c0-5.47-4.43-9.9-9.9-9.9z"/>
</svg>
  </a>

  
  
  
  

  

  

  <!-- Optional additional links to insert for icons links -->
</nav>
  <p>
  &copy; 2020.

  Vignessh
  <!-- <a href="/LICENSE.md">MIT License.</a> -->
</p>
</div>

    <main class="container">
      <header>
  <h1 class="post-title">Using Castle TypeFactory facility</h1>
</header>
<div class="content">
  <div class="post-meta">
  <span class="post-date">28 Apr 2013</span>
  <span class="post-categories">
    
  </span>
</div>

  <div class="post-body">
    <p>Recently we ran into a problem with unit testing a piece of C# code because of the way the objects were created within the class under test. We were using Castle Windsor to inject the dependencies already but this particular situation was troublesome for us.
<!--more--></p>

<p>Consider the following sample code:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">AccountFinder</span>
<span class="p">{</span>
	<span class="k">private</span> <span class="n">IAccountRepository</span> <span class="n">repository</span><span class="p">;</span>

	<span class="k">public</span> <span class="nf">AccountFinder</span><span class="p">(</span><span class="n">IAccountRepository</span> <span class="n">repository</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">this</span><span class="p">.</span><span class="n">repository</span> <span class="p">=</span> <span class="n">repository</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">public</span> <span class="n">Account</span> <span class="nf">Find</span><span class="p">(</span><span class="n">SearchCriteria</span> <span class="n">criteria</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="kt">var</span> <span class="n">searchStrategy</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">AccountSearchStrategyBuilder</span><span class="p">(</span><span class="n">repository</span><span class="p">).</span><span class="nf">Create</span><span class="p">(</span><span class="n">criteria</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">searchStrategy</span><span class="p">.</span><span class="nf">Find</span><span class="p">(</span><span class="n">criteria</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">AccountFinder</code> depends on the following bit of code to create the right kind of strategy.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">AccountSearchStrategyBuilder</span>
<span class="p">{</span>
	<span class="k">private</span> <span class="n">IAccountRepository</span> <span class="n">repository</span><span class="p">;</span>

	<span class="k">public</span> <span class="nf">AccountSearchStrategyBuilder</span><span class="p">(</span><span class="n">IAccountRepository</span> <span class="n">repository</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">this</span><span class="p">.</span><span class="n">repository</span> <span class="p">=</span> <span class="n">repository</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">public</span> <span class="n">AccountSearchStrategy</span> <span class="nf">Create</span><span class="p">(</span><span class="n">SearchCriteria</span> <span class="n">criteria</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">critera</span><span class="p">.</span><span class="n">CustomerId</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
			<span class="k">return</span> <span class="k">new</span> <span class="nf">AccountSearchByCustomerIdStrategy</span><span class="p">(</span><span class="n">repository</span><span class="p">);</span>
		<span class="k">return</span> <span class="k">new</span> <span class="nf">DefaultAccountSearchStrategy</span><span class="p">(</span><span class="n">repository</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>As you can see in the <code class="language-plaintext highlighter-rouge">AccountSearchStrategyBuilder</code> implementation, we end up creating the instances of the strategies themselves because we can decide on the type of the strategy to create only after we inspect the <code class="language-plaintext highlighter-rouge">SearchCriteria</code>. So, that implies testing the <code class="language-plaintext highlighter-rouge">AccountSearchStrategyBuilder</code> would mean creation of the various implementations even though we do not really need them. And the builder needs to be injected with all the dependencies that are required by the individual strategy implementations. Yikes!!</p>

<p>So how do we solve the problem? Castle Windsor has a <a href="https://github.com/castleproject/Windsor/blob/master/docs/typed-factory-facility.md">facility</a> specifically to address this particular problem. The idea is we delegate the creational responsibility to the container whilst still being able to select a particular implementation based on the input available to us at runtime.</p>

<p>The new implementation of the StrategyBuilder looks like</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">AccountSearchStrategySelector</span> <span class="p">:</span> <span class="n">DefaultTypedFactoryComponentSelector</span>
<span class="p">{</span>
	<span class="k">protected</span> <span class="k">override</span> <span class="n">Type</span> <span class="nf">GetComponentType</span><span class="p">(</span><span class="n">MethodInfo</span> <span class="n">method</span><span class="p">,</span> <span class="kt">object</span><span class="p">[]</span> <span class="n">arguments</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="kt">var</span> <span class="n">searchCriteria</span> <span class="p">=</span> <span class="p">(</span><span class="n">SearchCriteria</span><span class="p">)</span> <span class="n">arguments</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">searchCriteria</span><span class="p">.</span><span class="n">CustomerId</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
			<span class="k">return</span> <span class="k">typeof</span><span class="p">(</span><span class="n">AccountSearchByCustomerIdStrategy</span><span class="p">);</span>
		<span class="k">return</span> <span class="k">typeof</span><span class="p">(</span><span class="n">DefaultAccountSearchStrategy</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<p>This way, we are separating the responsibility clearly - the creational logic of wiring in the right dependencies is not expressed in our code. It stays with Windsor. But how do we use this in our <code class="language-plaintext highlighter-rouge">AccountFinder</code> code? Here is how</p>

<p>First we need an interface that Windsor can implement for the <code class="language-plaintext highlighter-rouge">AccountSearchStrategySelector</code></p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">interface</span> <span class="nc">IAccountSearchStrategyBuilder</span>
<span class="p">{</span>
	<span class="n">IAccountSearchStrategy</span> <span class="nf">Create</span><span class="p">(</span><span class="n">SearchCriteria</span> <span class="n">criteria</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This interface will not have an implementation in our codebase. It is purely used by Castle Windsor to generate a proxy which can be used in our <code class="language-plaintext highlighter-rouge">AccountFinder</code> implementation.</p>

<p>Our Castle Windsor configuration now looks like below:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">container</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">WindsorContainer</span><span class="p">();</span>
<span class="n">container</span><span class="p">.</span><span class="n">AddFacility</span><span class="p">&lt;</span><span class="n">TypedFactoryFacility</span><span class="p">&gt;();</span>
<span class="n">container</span><span class="p">.</span><span class="nf">Register</span><span class="p">(</span><span class="n">Component</span><span class="p">.</span><span class="n">For</span><span class="p">&lt;</span><span class="n">IAccountSearchStrategyBuilder</span><span class="p">&gt;().</span><span class="nf">AsFactory</span><span class="p">(</span><span class="n">f</span> <span class="p">=&gt;</span> <span class="n">f</span><span class="p">.</span><span class="n">SelectWith</span><span class="p">&lt;</span><span class="n">AccountSearchStrategySelector</span><span class="p">&gt;()));</span>
<span class="n">container</span><span class="p">.</span><span class="nf">Register</span><span class="p">(</span><span class="n">Component</span><span class="p">.</span><span class="n">For</span><span class="p">&lt;</span><span class="n">AccountSearchStrategySelector</span><span class="p">,</span> <span class="n">ITypedFactoryComponentSelector</span><span class="p">&gt;());</span>
</code></pre></div></div>

<p>We are basically registering the <code class="language-plaintext highlighter-rouge">TypedFactoryFacility</code> with the container and then telling Windsor to use that factory to select an implementation type using the <code class="language-plaintext highlighter-rouge">.AsFactory</code> extension method when registering the <code class="language-plaintext highlighter-rouge">IAccountSearchStrategyBuilder</code>.</p>

<p>The newer version of <code class="language-plaintext highlighter-rouge">AccountFinder</code> looks like below</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">AccountFinder</span>
<span class="p">{</span>
	<span class="k">private</span> <span class="n">IAccountRepository</span> <span class="n">repository</span><span class="p">;</span>
	<span class="k">private</span> <span class="n">IAccountSearchStrategyBuilder</span> <span class="n">searchStrategyBuilder</span><span class="p">;</span>

	<span class="k">public</span> <span class="nf">AccountFinder</span><span class="p">(</span><span class="n">IAccountRepository</span> <span class="n">repository</span><span class="p">,</span> <span class="n">IAccountSearchStrategyBuilder</span> <span class="n">searchStrategyBuilder</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">this</span><span class="p">.</span><span class="n">repository</span> <span class="p">=</span> <span class="n">repository</span><span class="p">;</span>
		<span class="k">this</span><span class="p">.</span><span class="n">searchStrategyBuilder</span> <span class="p">=</span> <span class="n">searchStrategyBuilder</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">public</span> <span class="n">Account</span> <span class="nf">Find</span><span class="p">(</span><span class="n">SearchCriteria</span> <span class="n">criteria</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="kt">var</span> <span class="n">searchStrategy</span> <span class="p">=</span> <span class="n">searchStrategyBuilder</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="n">criteria</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">searchStrategy</span><span class="p">.</span><span class="nf">Find</span><span class="p">(</span><span class="n">criteria</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This way, we can test our individual classes easily by supplying mock/stubs instead of dealing with live instances that might require complicated setup.</p>

<h4 id="summary">Summary</h4>

<p>Use this facility when you need to choose amongst a bunch of implementations based on input received at runtime. Next time you end up <a href="http://www.urbandictionary.com/define.php?term=yak+shaving">Yak shaving</a>, understand why you ended up doing it and see what can be done to ease the pain. And yeah, reading the manual helps too!</p>

    <div class="post-tags">
  
    <span>
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">csharp</span>
    </span>
  
    <span>
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">castle windsor</span>
    </span>
  
    <span>
      <span class="icon">
        <svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 0h24v24H0z" fill="none"/>
    <path d="M17.63 5.84C17.27 5.33 16.67 5 16 5L5 5.01C3.9 5.01 3 5.9 3 7v10c0 1.1.9 1.99 2 1.99L16 19c.67 0 1.27-.33 1.63-.84L22 12l-4.37-6.16z"/>
</svg>
      </span>&nbsp;<span class="tag-name">tdd</span>
    </span>
  
</div>
  </div>

  <section class="comments">
    <h2>Comments</h2>
    <div id="disqus_thread">
    <button class="disqus-load" onClick="loadDisqusComments()">
      Load Comments
    </button>
  </div>
  <script>

  /**
  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW
  *  TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT:s
  *  https://disqus.com/admin/universalcode/#configuration-variables
  */
  var disqus_config = function () {
    this.page.url = "https://vignessh.github.io/blog/2013/04/28/using-castle-typefactory-facility/";
    this.page.identifier = "" ||
                           "https://vignessh.github.io/blog/2013/04/28/using-castle-typefactory-facility/";
  }
  function loadDisqusComments() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = '//vignessh.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  }
  </script>
  <noscript>
    Please enable JavaScript to view the
    <a href="https://disqus.com/?ref_noscript">comments powered by Disqus</a>.
  </noscript>
  </section>
  <section class="related">
  <h2>Related Posts</h2>
  <ul class="posts-list">
    
      <li>
        <h3>
          <a href="/blog/2013/05/10/using-dependency-injection-correctly/">
            Using dependency injection correctly
            <small>10 May 2013</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/blog/2013/04/27/learning-functional-programming/">
            Learning functional programming - Part 1
            <small>27 Apr 2013</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/blog/2013/04/26/laziness-a-human-quality/">
            Laziness: A human quality
            <small>26 Apr 2013</small>
          </a>
        </h3>
      </li>
    
  </ul>
</section>
</div>

    </main>

    <!-- Optional footer content -->
  </body>
</html>
